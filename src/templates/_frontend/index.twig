{#
    Bucket list / passport frontend page.
    Override by placing _stamp-passport/index.twig in your site templates.
#}
{% extends "_stamp-passport/_layout" %}

{% set settings = craft.stampPassport.settings %}
{% set items    = craft.stampPassport.items %}

{% set logoUrl     = settings.logoAssetId     ? craft.stampPassport.imageUrl(settings.logoAssetId)     : null %}
{% set woodPanelUrl = settings.woodPanelAssetId ? craft.stampPassport.imageUrl(settings.woodPanelAssetId) : null %}

{% block title %}{{ settings.pluginName }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ craft.app.assetManager.getPublishedUrl('@csabourin/stamppassport/web/assets/frontend/css/passport.css', true) }}">
    {% if woodPanelUrl %}
    <style>
        .passport-header.has-wood-bg {
            --passport-wood-img: url('{{ woodPanelUrl|e }}');
        }
    </style>
    {% endif %}
{% endblock %}

{% block content %}

    {# â”€â”€ Header â€” wood panel with circular logo â”€â”€ #}
    <header class="passport-header{{ woodPanelUrl ? ' has-wood-bg' : '' }}">
        <div class="passport-header-logo">
            {% if logoUrl %}
                <img src="{{ logoUrl }}" alt="{{ settings.pluginName }}" class="passport-logo">
            {% else %}
                <div class="passport-logo-placeholder">ğŸ</div>
            {% endif %}
        </div>

        <p class="passport-org">
            National Capital Commission<br>
            Commission de la capitale nationale
        </p>

        <h1 class="passport-title">
            <span class="passport-title-light">{{ settings.pluginName }}</span>
            <span class="passport-title-bold">{{ "Challenge"|t('stamp-passport') }}</span>
        </h1>
    </header>

    {# â”€â”€ Instruction strip â”€â”€ #}
    <div class="passport-scan-strip">
        {{ "Scan all QR codes at official locations to complete your summer bucket list."|t('stamp-passport') }}
    </div>

    {# â”€â”€ Status area for scan feedback (JS-populated, announced to AT) â”€â”€ #}
    <section id="statusSection" class="passport-status hidden" role="status" aria-live="polite" aria-atomic="true"></section>

    {# â”€â”€ Item list â”€â”€ #}
    <section class="passport-grid" id="stampGrid">
        {% for item in items %}
            {% set content = item.contents[0] ?? null %}
            <article class="stamp-slot" data-code="{{ item.shortCode }}" data-id="{{ item.id }}">

                <div class="stamp-image">
                    {% if item.imageId %}
                        {% set asset = craft.assets.id(item.imageId).one() %}
                        {% if asset %}
                            <img src="{{ asset.getUrl() }}" alt="{{ content.title ?? '' }}" loading="lazy">
                        {% endif %}
                    {% endif %}
                    <div class="stamp-check hidden" aria-hidden="true">&#10003;</div>
                </div>

                <div class="stamp-info">
                    <h3 class="stamp-title">{{ content.title ?? '' }}</h3>
                    <p class="stamp-desc">{{ content.description ?? '' }}</p>
                    {% if content and content.linkUrl %}
                        <a class="stamp-link" href="{{ content.linkUrl }}" target="_blank" rel="noopener">
                            {{ content.linkText ?? 'Learn more'|t('stamp-passport') }}
                        </a>
                    {% endif %}
                </div>

            </article>
        {% endfor %}
    </section>

    {# â”€â”€ Progress bar â”€â”€ #}
    <section class="passport-progress" aria-label="{{ 'Progress'|t('stamp-passport') }}">
        <div class="progress-bar"
             role="progressbar"
             aria-valuenow="0"
             aria-valuemin="0"
             aria-valuemax="{{ items|length }}"
             aria-describedby="progressText">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <p class="progress-text" id="progressText" aria-live="polite"></p>
    </section>

    {# â”€â”€ Draw modal â”€â”€ #}
    {% set drawHandle = settings.freeformDrawFormHandle %}
    {% if drawHandle %}
        <div id="drawModal" class="passport-modal hidden" role="dialog" aria-labelledby="drawModalTitle">
            <div class="passport-modal-backdrop"></div>
            <div class="passport-modal-content">
                <button class="passport-modal-close" aria-label="Close">&times;</button>
                <h2 id="drawModalTitle">{{ 'Enter the Draw!'|t('stamp-passport') }}</h2>
                <p>{{ "You've unlocked the draw entry! Fill in the form below for a chance to win."|t('stamp-passport') }}</p>
                <div id="drawFormContainer">
                    {{ craft.freeform.form(drawHandle, { ajax: true }) }}
                </div>
            </div>
        </div>
    {% endif %}

    {# â”€â”€ Sticker modal â”€â”€ #}
    {% set stickerHandle = settings.freeformStickerFormHandle %}
    {% if stickerHandle %}
        <div id="stickerModal" class="passport-modal hidden" role="dialog" aria-labelledby="stickerModalTitle">
            <div class="passport-modal-backdrop"></div>
            <div class="passport-modal-content">
                <button class="passport-modal-close" aria-label="Close">&times;</button>
                <h2 id="stickerModalTitle">{{ 'Memory Makers!'|t('stamp-passport') }}</h2>
                <p>{{ "Congratulations! You've completed the full bucket list. Claim your limited-edition sticker."|t('stamp-passport') }}</p>
                <div id="stickerFormContainer">
                    {{ craft.freeform.form(stickerHandle, { ajax: true }) }}
                </div>
            </div>
        </div>
    {% endif %}

    {# â”€â”€ Disclaimer modal (shown once) â”€â”€ #}
    <div id="disclaimerModal" class="passport-modal hidden" role="dialog" aria-labelledby="disclaimerTitle">
        <div class="passport-modal-backdrop"></div>
        <div class="passport-modal-content">
            <h2 id="disclaimerTitle">{{ "Before You Begin"|t('stamp-passport') }}</h2>
            <p>{{ "Your progress is saved locally and synced online. Use the language toggle to switch between English and French without losing your stamps."|t('stamp-passport') }}</p>
            <button id="disclaimerAccept" class="passport-btn passport-btn-primary">
                {{ "Got it, let's go!"|t('stamp-passport') }}
            </button>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{{ craft.app.assetManager.getPublishedUrl('@csabourin/stamppassport/web/assets/frontend/js/passport.js', true) }}"></script>
{% endblock %}
