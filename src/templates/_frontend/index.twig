{#
    Bucket list / passport frontend page.
    Override by placing _stamp-passport/index.twig in your site templates.
#}
{% extends "_stamp-passport/_layout" %}

{% set settings = craft.stampPassport.settings %}
{% set items    = craft.stampPassport.items %}
{% set t        = craft.stampPassport %}

{% set logoUrl     = settings.logoAssetId     ? craft.stampPassport.imageUrl(settings.logoAssetId)     : null %}
{% set woodPanelUrl = settings.woodPanelAssetId ? craft.stampPassport.imageUrl(settings.woodPanelAssetId) : null %}

{% block title %}{{ settings.pluginName }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ craft.app.assetManager.getPublishedUrl('@csabourin/stamppassport/web/assets/frontend/css/passport.css', true) }}">
    {% if woodPanelUrl %}
    <style>
        .passport-header.has-wood-bg {
            --passport-wood-img: url('{{ woodPanelUrl|e }}');
        }
    </style>
    {% endif %}
{% endblock %}

{% block content %}

    {# ‚îÄ‚îÄ Header ‚Äî wood panel with circular logo ‚îÄ‚îÄ #}
    <header class="passport-header{{ woodPanelUrl ? ' has-wood-bg' : '' }}">

        {# ‚îÄ‚îÄ Language switcher (top-right) ‚îÄ‚îÄ #}
        {% set allSites = craft.app.sites.allSites %}
        {% if allSites|length > 1 %}
        <nav class="passport-lang-nav" aria-label="{{ 'Language'|t('stamp-passport') }}">
            {% for site in allSites %}
                {% if site.id != currentSite.id %}
                    {% set siteBaseUrl = (site.getBaseUrl() ?? '')|trim('/') ~ '/' %}
                    <a href="{{ siteBaseUrl ~ settings.routePrefix }}"
                       class="passport-lang-link"
                       data-passport-lang="{{ site.language[:2] }}"
                       data-passport-href="{{ siteBaseUrl ~ settings.routePrefix }}"
                       lang="{{ site.language[:2] }}"
                       hreflang="{{ site.language[:2] }}"
                       aria-label="{{ site.name }}">
                        {{ site.language[:2]|upper }}
                    </a>
                {% endif %}
            {% endfor %}
        </nav>
        {% endif %}

        <div class="passport-header-logo">
            {% if logoUrl %}
                <img src="{{ logoUrl }}" alt="{{ settings.pluginName }}" class="passport-logo">
            {% else %}
                <div class="passport-logo-placeholder">üçÅ</div>
            {% endif %}
        </div>

        <p class="passport-org">
            {{ t.text('orgName')|nl2br }}
        </p>

        <h1 class="passport-title">
            <span class="passport-title-light">{{ settings.pluginName }}</span>
            <span class="passport-title-bold">{{ t.text('challengeTitle') }}</span>
        </h1>
    </header>

    {# ‚îÄ‚îÄ Instruction strip ‚îÄ‚îÄ #}
    <div class="passport-scan-strip">
        {{ t.text('scanInstructions') }}
    </div>

    {# ‚îÄ‚îÄ Status area for scan feedback (JS-populated, announced to AT) ‚îÄ‚îÄ #}
    <section id="statusSection" class="passport-status hidden" role="status" aria-live="polite" aria-atomic="true"></section>

    {# ‚îÄ‚îÄ Item list ‚îÄ‚îÄ #}
    <section class="passport-grid" id="stampGrid">
        {% for item in items %}
            {% set content = item.contents[0] ?? null %}
            <article class="stamp-slot" data-code="{{ item.shortCode }}" data-id="{{ item.id }}">

                <button class="stamp-image-btn"
                        type="button"
                        aria-label="{{ 'Details'|t('stamp-passport') }}: {{ content.title ?? '' }}"
                        aria-haspopup="dialog"
                        data-item-id="{{ item.id }}"
                        data-item-link-url="{{ content.linkUrl ?? '' }}"
                        data-item-link-text="{{ (content is not null and content.linkText is not empty) ? content.linkText : 'Learn more'|t('stamp-passport') }}">
                    <div class="stamp-image">
                        {% if item.imageId %}
                            {% set asset = craft.assets.id(item.imageId).one() %}
                            {% if asset %}
                                <img src="{{ asset.getUrl() }}" alt="" loading="lazy">
                            {% endif %}
                        {% endif %}
                        <div class="stamp-check hidden" aria-hidden="true">&#10003;</div>
                    </div>
                </button>

                {# Description HTML stored for the detail modal ‚Äî not displayed inline #}
                <template id="item-desc-{{ item.id }}">{{ content.description|default('')|raw }}</template>

                <div class="stamp-info">
                    <h3 class="stamp-title">{{ content.title ?? '' }}</h3>
                </div>

            </article>
        {% endfor %}
    </section>

    {# ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ #}
    <section class="passport-progress" aria-label="{{ 'Progress'|t('stamp-passport') }}">
        <div class="progress-bar"
             role="progressbar"
             aria-valuenow="0"
             aria-valuemin="0"
             aria-valuemax="{{ items|length }}"
             aria-describedby="progressText">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <p class="progress-text" id="progressText" aria-live="polite"></p>
    </section>

    {# ‚îÄ‚îÄ Item detail modal (shared, populated by JS on image click) ‚îÄ‚îÄ #}
    <div id="itemDetailModal" class="passport-modal hidden"
         role="dialog"
         aria-modal="true"
         aria-labelledby="itemDetailModalTitle">
        <div class="passport-modal-backdrop"></div>
        <div class="passport-modal-content">
            <button class="passport-modal-close" aria-label="{{ 'Close'|t('stamp-passport') }}">&times;</button>
            <h2 id="itemDetailModalTitle" class="item-detail-title"></h2>
            <div class="item-detail-body"></div>
            <div class="item-detail-footer">
                <a class="passport-btn passport-btn-secondary item-detail-link hidden"
                   target="_blank"
                   rel="noopener noreferrer"></a>
            </div>
        </div>
    </div>

    {# ‚îÄ‚îÄ Draw modal ‚îÄ‚îÄ #}
    {% set drawHandle = settings.freeformDrawFormHandle %}
    {% if drawHandle %}
        <div id="drawModal" class="passport-modal hidden" role="dialog" aria-labelledby="drawModalTitle">
            <div class="passport-modal-backdrop"></div>
            <div class="passport-modal-content">
                <button class="passport-modal-close" aria-label="{{ 'Close'|t('stamp-passport') }}">&times;</button>
                <h2 id="drawModalTitle">{{ t.text('drawModalTitle') }}</h2>
                <p>{{ t.text('drawModalBody') }}</p>
                <div id="drawFormContainer">
                    {{ craft.freeform.form(drawHandle, { ajax: true }) }}
                </div>
            </div>
        </div>
    {% endif %}

    {# ‚îÄ‚îÄ Sticker modal ‚îÄ‚îÄ #}
    {% set stickerHandle = settings.freeformStickerFormHandle %}
    {% if stickerHandle %}
        <div id="stickerModal" class="passport-modal hidden" role="dialog" aria-labelledby="stickerModalTitle">
            <div class="passport-modal-backdrop"></div>
            <div class="passport-modal-content">
                <button class="passport-modal-close" aria-label="{{ 'Close'|t('stamp-passport') }}">&times;</button>
                <h2 id="stickerModalTitle">{{ t.text('stickerModalTitle') }}</h2>
                <p>{{ t.text('stickerModalBody') }}</p>
                <div id="stickerFormContainer">
                    {{ craft.freeform.form(stickerHandle, { ajax: true }) }}
                </div>
            </div>
        </div>
    {% endif %}

    {# ‚îÄ‚îÄ Disclaimer modal (shown once) ‚îÄ‚îÄ #}
    <div id="disclaimerModal" class="passport-modal hidden" role="dialog" aria-labelledby="disclaimerTitle">
        <div class="passport-modal-backdrop"></div>
        <div class="passport-modal-content">
            <h2 id="disclaimerTitle">{{ t.text('disclaimerTitle') }}</h2>
            <p>{{ t.text('disclaimerBody') }}</p>
            <button id="disclaimerAccept" class="passport-btn passport-btn-primary">
                {{ t.text('disclaimerButton') }}
            </button>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{{ craft.app.assetManager.getPublishedUrl('@csabourin/stamppassport/web/assets/frontend/js/passport.js', true) }}"></script>
{% endblock %}
