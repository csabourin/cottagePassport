{% extends "_layouts/cp" %}

{% import "_includes/forms" as forms %}

{% set selectedSubnavItem = 'items' %}

{% set crumbs = [
    { label: craft.app.plugins.getPlugin('stamp-passport').settings.pluginName, url: url('stamp-passport') },
    { label: 'Items'|t('stamp-passport'), url: url('stamp-passport/items') },
] %}

{# ── Site toggle in header (next to the page title) ── #}
{% block contextMenu %}
    {% if craft.app.isMultiSite %}
        <div>
            <button type="button" class="btn menubtn" data-icon="world">{{ currentSite.name }}</button>
            <div class="menu">
                <ul class="padded">
                    {% for site in sites %}
                        <li>
                            <a href="{{ url('stamp-passport/items/' ~ (item ? item.id : 'new'), { site: site.handle }) }}"
                               {% if site.id == currentSite.id %}class="sel"{% endif %}>
                                {{ site.name }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{# ── Save button in the header action area ── #}
{% block actionButton %}
    <button type="submit" form="item-form" class="btn submit">{{ "Save"|t('app') }}</button>
{% endblock %}

{# ── Main form ── #}
{% block content %}
    <form id="item-form" method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('stamp-passport/cp/save') }}
        {{ hiddenInput('siteId', currentSite.id) }}

        {% if item %}
            {{ hiddenInput('itemId', item.id) }}
        {% endif %}

        <div id="fields">

            {# Short Code (read-only, shown under the language switcher) #}
            {% if item %}
                <div class="meta read-only" style="margin-bottom: 1.5em;">
                    <div class="field">
                        <div class="heading">
                            <label>{{ "Short Code"|t('stamp-passport') }}</label>
                        </div>
                        <div class="value">
                            <code style="font-size:1.1em">{{ item.shortCode }}</code>
                        </div>
                        <div class="instructions">
                            <p class="smalltext light">{{ "Auto-generated. Used in QR code URLs."|t('stamp-passport') }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Enabled toggle #}
            {{ forms.lightswitchField({
                label: "Enabled"|t('app'),
                name: 'enabled',
                on: item ? item.enabled : true,
            }) }}

            <hr>

            {# ── Coordinates — side by side ── #}
            <h2>{{ "Coordinates"|t('stamp-passport') }}</h2>
            <div class="flex gap-4">
                <div class="flex-grow">
                    {{ forms.textField({
                        label: "Latitude"|t('stamp-passport'),
                        name: 'latitude',
                        value: item ? item.latitude : '',
                        placeholder: '45.4281237',
                        size: 20,
                    }) }}
                </div>
                <div class="flex-grow">
                    {{ forms.textField({
                        label: "Longitude"|t('stamp-passport'),
                        name: 'longitude',
                        value: item ? item.longitude : '',
                        placeholder: '-75.6942809',
                        size: 20,
                    }) }}
                </div>
            </div>

            <hr>

            {# ── Image ── #}
            <h2>{{ "Image"|t('stamp-passport') }}</h2>

            {% set imageElements = [] %}
            {% if item and item.imageId %}
                {% set asset = craft.assets.id(item.imageId).one() %}
                {% if asset %}
                    {% set imageElements = [asset] %}
                {% endif %}
            {% endif %}

            {{ forms.elementSelectField({
                label: "Location Image"|t('stamp-passport'),
                name: 'imageId',
                elementType: 'craft\\elements\\Asset',
                criteria: { kind: 'image' },
                limit: 1,
                elements: imageElements,
                modalStorageKey: 'stamp-passport.image',
            }) }}

            <hr>

            {# ── Per-site translatable fields ── #}
            <h2>{{ currentSite.name }} {{ "Content"|t('stamp-passport') }}</h2>

            {% set sc = content[currentSite.id] ?? {} %}

            {{ forms.textField({
                label: "Title"|t('stamp-passport'),
                name: 'content[' ~ currentSite.id ~ '][title]',
                value: sc.title ?? '',
                required: true,
            }) }}

            {{ forms.textareaField({
                label: "Description"|t('stamp-passport'),
                name: 'content[' ~ currentSite.id ~ '][description]',
                id: 'stamp-desc-' ~ currentSite.id,
                value: sc.description ?? '',
                rows: 8,
            }) }}

            {{ forms.textField({
                label: "Link URL"|t('stamp-passport'),
                name: 'content[' ~ currentSite.id ~ '][linkUrl]',
                value: sc.linkUrl ?? '',
                placeholder: 'https://',
            }) }}

            {{ forms.textField({
                label: "Link Text"|t('stamp-passport'),
                name: 'content[' ~ currentSite.id ~ '][linkText]',
                value: sc.linkText ?? '',
                placeholder: 'Learn more',
            }) }}

        </div>{# /fields #}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
        </div>

    </form>
{% endblock %}

{# ── CKEditor 5 for the description field (uses craftcms/ckeditor if installed) ── #}
{% block foot %}
    {{ parent() }}
    {% if craft.app.plugins.getPlugin('ckeditor') %}
        {# Register CKEditor 5 via the installed craftcms/ckeditor plugin — no external CDN needed #}
        {% do view.registerAssetBundle('craft\\ckeditor\\web\\assets\\ckeditor\\CkeditorAsset') %}
        {% js %}
        (function () {
            if (typeof CKEditor5 === 'undefined' || typeof CKEditor5.craftcms === 'undefined') return;
            var el = document.getElementById('stamp-desc-{{ currentSite.id }}');
            if (!el) return;

            CKEditor5.craftcms.create(el, {
                toolbar: {
                    items: [
                        'bold', 'italic', '|',
                        'link', '|',
                        'bulletedList', 'numberedList', '|',
                        'blockQuote', '|',
                        'undo', 'redo'
                    ]
                },
                language: '{{ currentSite.language[:2]|lower }}',
                ui: { viewportOffset: { top: 50 } },
            });
        })();
        {% endjs %}
    {% endif %}
{% endblock %}

