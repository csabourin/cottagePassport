{% extends "_layouts/cp" %}

{% set title = "Settings"|t('stamp-passport') %}
{% set selectedSubnavItem = 'settings' %}

{% set crumbs = [
    { label: settings.pluginName, url: url('stamp-passport') },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('stamp-passport/cp/save-settings') }}
        {{ redirectInput('stamp-passport/settings') }}

        <h2>{{ "General"|t('stamp-passport') }}</h2>

        {{ forms.textField({
            first: true,
            label: "Plugin Name"|t('stamp-passport'),
            instructions: "Display name shown in the CP navigation."|t('stamp-passport'),
            name: 'pluginName',
            value: settings.pluginName,
            required: true,
        }) }}

        {{ forms.textField({
            label: "Route Prefix"|t('stamp-passport'),
            instructions: "URL prefix for the frontend page (e.g. \"passport\" → /en/passport)."|t('stamp-passport'),
            name: 'routePrefix',
            value: settings.routePrefix,
            required: true,
        }) }}

        <hr>

        <h2>{{ "Geofence"|t('stamp-passport') }}</h2>

        {{ forms.lightswitchField({
            label: "Enable Geofence"|t('stamp-passport'),
            instructions: "When enabled, visitors must be within the configured radius of a location to check in."|t('stamp-passport'),
            name: 'enableGeofence',
            on: settings.enableGeofence,
        }) }}

        {{ forms.textField({
            label: "Geofence Radius (metres)"|t('stamp-passport'),
            name: 'geofenceRadius',
            value: settings.geofenceRadius,
            type: 'number',
            min: 50,
            max: 10000,
            size: 10,
        }) }}

        <hr>

        <h2>{{ "Prizes"|t('stamp-passport') }}</h2>

        {{ forms.textField({
            label: "Draw Threshold"|t('stamp-passport'),
            instructions: "Number of stamps required before the draw entry form appears."|t('stamp-passport'),
            name: 'drawThreshold',
            value: settings.drawThreshold,
            type: 'number',
            min: 1,
            size: 5,
        }) }}

        {{ forms.textField({
            label: "Max Stickers"|t('stamp-passport'),
            instructions: "Maximum number of sticker prizes available (0 = unlimited)."|t('stamp-passport'),
            name: 'maxStickers',
            value: settings.maxStickers,
            type: 'number',
            min: 0,
            size: 5,
        }) }}

        <hr>

        <h2>{{ "Freeform Integration"|t('stamp-passport') }}</h2>

        {{ forms.textField({
            label: "Draw Form Handle"|t('stamp-passport'),
            instructions: "Freeform form handle for the end-of-season draw entry."|t('stamp-passport'),
            name: 'freeformDrawFormHandle',
            value: settings.freeformDrawFormHandle,
            placeholder: 'passportDraw',
        }) }}

        {{ forms.textField({
            label: "Sticker Form Handle"|t('stamp-passport'),
            instructions: "Freeform form handle for the Memory Makers sticker request."|t('stamp-passport'),
            name: 'freeformStickerFormHandle',
            value: settings.freeformStickerFormHandle,
            placeholder: 'passportSticker',
        }) }}

        <hr>

        <h2>{{ "Appearance"|t('stamp-passport') }}</h2>

        {% set logoElements = settings.logoAssetId ? craft.assets.id(settings.logoAssetId).all() : [] %}
        {{ forms.elementSelectField({
            label: "Header Logo"|t('stamp-passport'),
            instructions: "Circular image displayed at the top of the page header. Recommended: square PNG with transparent background."|t('stamp-passport'),
            id: 'logoAssetId',
            name: 'logoAssetId',
            elementType: 'craft\\elements\\Asset',
            criteria: { kind: 'image' },
            limit: 1,
            elements: logoElements,
            modalStorageKey: 'stamp-passport.logoAsset',
        }) }}

        {% set woodElements = settings.woodPanelAssetId ? craft.assets.id(settings.woodPanelAssetId).all() : [] %}
        {{ forms.elementSelectField({
            label: "Header Wood Panel"|t('stamp-passport'),
            instructions: "Background image for the page header. If not set, a CSS wood-grain texture is used as fallback."|t('stamp-passport'),
            id: 'woodPanelAssetId',
            name: 'woodPanelAssetId',
            elementType: 'craft\\elements\\Asset',
            criteria: { kind: 'image' },
            limit: 1,
            elements: woodElements,
            modalStorageKey: 'stamp-passport.woodPanelAsset',
        }) }}

        <hr>

        <h2>{{ "Analytics"|t('stamp-passport') }}</h2>

        {{ forms.textField({
            label: "GA4 Measurement ID"|t('stamp-passport'),
            instructions: "Google Analytics 4 measurement ID (e.g. G-XXXXXXXXXX). Leave blank to disable."|t('stamp-passport'),
            name: 'ga4MeasurementId',
            value: settings.ga4MeasurementId,
            placeholder: 'G-XXXXXXXXXX',
        }) }}

        <hr>

        {# ── Per-site display text customization ── #}
        <h2>{{ "Display Text"|t('stamp-passport') }}</h2>
        <p class="light">{{ "Customize all display text per site. Leave fields blank to use built-in defaults for that language."|t('stamp-passport') }}</p>

        {% set allSites = craft.app.sites.allSites %}
        {% set textDefaults = constant('csabourin\\stamppassport\\models\\Settings::TEXT_DEFAULTS') %}
        {% set textLabels = constant('csabourin\\stamppassport\\models\\Settings::TEXT_LABELS') %}
        {% set textKeys = constant('csabourin\\stamppassport\\models\\Settings::TEXT_KEYS') %}

        {# Site tabs #}
        {% if allSites|length > 1 %}
        <div class="btngroup" id="siteTextTabs" style="margin-bottom: 1em;">
            {% for site in allSites %}
                <button type="button"
                        class="btn{{ loop.first ? ' active' : '' }}"
                        data-site-text-tab="{{ site.handle }}">
                    {{ site.name }} ({{ site.language[:2]|upper }})
                </button>
            {% endfor %}
        </div>
        {% endif %}

        {% for site in allSites %}
            {% set lang = site.language[:2] %}
            {% set defaults = textDefaults[lang] ?? textDefaults['en'] %}
            <div class="stamp-passport-site-text{{ not loop.first ? ' hidden' : '' }}"
                 data-site-text-panel="{{ site.handle }}">

                {% if allSites|length > 1 %}
                    <h3>{{ site.name }} ({{ lang|upper }})</h3>
                {% endif %}

                <h4 style="margin-top:1.5em">{{ "Header"|t('stamp-passport') }}</h4>

                {{ forms.textareaField({
                    label: textLabels['orgName'],
                    instructions: "Organization name displayed in the page header. Use new lines for multiple lines."|t('stamp-passport'),
                    name: 'uiText[' ~ site.handle ~ '][orgName]',
                    value: settings.uiText[site.handle]['orgName'] ?? '',
                    placeholder: defaults['orgName']|replace({"\n": "\n"}),
                    rows: 2,
                }) }}

                {{ forms.textField({
                    label: textLabels['challengeTitle'],
                    instructions: "Bold title shown after the plugin name in the header."|t('stamp-passport'),
                    name: 'uiText[' ~ site.handle ~ '][challengeTitle]',
                    value: settings.uiText[site.handle]['challengeTitle'] ?? '',
                    placeholder: defaults['challengeTitle'],
                }) }}

                {{ forms.textField({
                    label: textLabels['scanInstructions'],
                    instructions: "Instruction text shown below the header."|t('stamp-passport'),
                    name: 'uiText[' ~ site.handle ~ '][scanInstructions]',
                    value: settings.uiText[site.handle]['scanInstructions'] ?? '',
                    placeholder: defaults['scanInstructions'],
                }) }}

                <h4 style="margin-top:1.5em">{{ "Draw Modal"|t('stamp-passport') }}</h4>

                {{ forms.textField({
                    label: textLabels['drawModalTitle'],
                    name: 'uiText[' ~ site.handle ~ '][drawModalTitle]',
                    value: settings.uiText[site.handle]['drawModalTitle'] ?? '',
                    placeholder: defaults['drawModalTitle'],
                }) }}

                {{ forms.textareaField({
                    label: textLabels['drawModalBody'],
                    name: 'uiText[' ~ site.handle ~ '][drawModalBody]',
                    value: settings.uiText[site.handle]['drawModalBody'] ?? '',
                    placeholder: defaults['drawModalBody'],
                    rows: 2,
                }) }}

                <h4 style="margin-top:1.5em">{{ "Sticker Modal"|t('stamp-passport') }}</h4>

                {{ forms.textField({
                    label: textLabels['stickerModalTitle'],
                    name: 'uiText[' ~ site.handle ~ '][stickerModalTitle]',
                    value: settings.uiText[site.handle]['stickerModalTitle'] ?? '',
                    placeholder: defaults['stickerModalTitle'],
                }) }}

                {{ forms.textareaField({
                    label: textLabels['stickerModalBody'],
                    name: 'uiText[' ~ site.handle ~ '][stickerModalBody]',
                    value: settings.uiText[site.handle]['stickerModalBody'] ?? '',
                    placeholder: defaults['stickerModalBody'],
                    rows: 2,
                }) }}

                <h4 style="margin-top:1.5em">{{ "Disclaimer Modal"|t('stamp-passport') }}</h4>

                {{ forms.textField({
                    label: textLabels['disclaimerTitle'],
                    name: 'uiText[' ~ site.handle ~ '][disclaimerTitle]',
                    value: settings.uiText[site.handle]['disclaimerTitle'] ?? '',
                    placeholder: defaults['disclaimerTitle'],
                }) }}

                {{ forms.textareaField({
                    label: textLabels['disclaimerBody'],
                    name: 'uiText[' ~ site.handle ~ '][disclaimerBody]',
                    value: settings.uiText[site.handle]['disclaimerBody'] ?? '',
                    placeholder: defaults['disclaimerBody'],
                    rows: 2,
                }) }}

                {{ forms.textField({
                    label: textLabels['disclaimerButton'],
                    name: 'uiText[' ~ site.handle ~ '][disclaimerButton]',
                    value: settings.uiText[site.handle]['disclaimerButton'] ?? '',
                    placeholder: defaults['disclaimerButton'],
                }) }}

                <h4 style="margin-top:1.5em">{{ "Status Messages"|t('stamp-passport') }}</h4>

                {{ forms.textField({
                    label: textLabels['alreadyCheckedIn'],
                    name: 'uiText[' ~ site.handle ~ '][alreadyCheckedIn]',
                    value: settings.uiText[site.handle]['alreadyCheckedIn'] ?? '',
                    placeholder: defaults['alreadyCheckedIn'],
                }) }}

                {{ forms.textField({
                    label: textLabels['checkingLocation'],
                    name: 'uiText[' ~ site.handle ~ '][checkingLocation]',
                    value: settings.uiText[site.handle]['checkingLocation'] ?? '',
                    placeholder: defaults['checkingLocation'],
                }) }}

                {{ forms.textField({
                    label: textLabels['locationError'],
                    name: 'uiText[' ~ site.handle ~ '][locationError]',
                    value: settings.uiText[site.handle]['locationError'] ?? '',
                    placeholder: defaults['locationError'],
                }) }}

                {{ forms.textField({
                    label: textLabels['checkinFailed'],
                    name: 'uiText[' ~ site.handle ~ '][checkinFailed]',
                    value: settings.uiText[site.handle]['checkinFailed'] ?? '',
                    placeholder: defaults['checkinFailed'],
                }) }}

                {{ forms.textField({
                    label: textLabels['checkedIn'],
                    name: 'uiText[' ~ site.handle ~ '][checkedIn]',
                    value: settings.uiText[site.handle]['checkedIn'] ?? '',
                    placeholder: defaults['checkedIn'],
                }) }}

                {{ forms.textField({
                    label: textLabels['qrNotRecognized'],
                    name: 'uiText[' ~ site.handle ~ '][qrNotRecognized]',
                    value: settings.uiText[site.handle]['qrNotRecognized'] ?? '',
                    placeholder: defaults['qrNotRecognized'],
                }) }}

                {{ forms.textField({
                    label: textLabels['loadError'],
                    name: 'uiText[' ~ site.handle ~ '][loadError]',
                    value: settings.uiText[site.handle]['loadError'] ?? '',
                    placeholder: defaults['loadError'],
                }) }}
            </div>
        {% endfor %}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
        </div>
    </form>

    {# Tab switching for multi-site text #}
    {% if allSites|length > 1 %}
    <script>
    (function() {
        var tabs = document.querySelectorAll('[data-site-text-tab]');
        var panels = document.querySelectorAll('[data-site-text-panel]');
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                var handle = tab.getAttribute('data-site-text-tab');
                tabs.forEach(function(t) { t.classList.remove('active'); });
                tab.classList.add('active');
                panels.forEach(function(p) {
                    if (p.getAttribute('data-site-text-panel') === handle) {
                        p.classList.remove('hidden');
                    } else {
                        p.classList.add('hidden');
                    }
                });
            });
        });
    })();
    </script>
    {% endif %}
{% endblock %}
