{% extends "_layouts/cp" %}

{% set title = "QR Codes"|t('cottage-passport') %}
{% set selectedSubnavItem = 'qr-generator' %}

{% set crumbs = [
    { label: settings.pluginName, url: url('cottage-passport') },
] %}

{% block content %}
    <div class="field">
        <div class="heading">
            <label for="qr-base-url">{{ "Base URL"|t('cottage-passport') }}</label>
            <div class="instructions">
                <p>{{ "The site URL where the passport frontend lives. QR codes will encode {baseUrl}?q={shortCode}."|t('cottage-passport') }}</p>
            </div>
        </div>
        <div class="input">
            <select id="qr-site-picker" class="text" style="margin-bottom:8px">
                {% for site in sites %}
                    <option value="{{ siteUrl(settings.routePrefix, {}, null, site.id) }}">
                        {{ site.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="buttons" style="margin-bottom:24px">
        <button id="btn-print" class="btn" type="button">{{ "Print All QR Codes"|t('cottage-passport') }}</button>
    </div>

    {% if items|length %}
        <div id="qr-grid" class="passport-qr-grid">
            {% for item in items %}
                {% set content = item.contents[0] ?? null %}
                <div class="qr-card" data-shortcode="{{ item.shortCode }}">
                    <div class="qr-image">
                        <img src="" alt="QR {{ item.shortCode }}" width="200" height="200" loading="lazy">
                    </div>
                    <div class="qr-label">
                        <strong>{{ content ? content.title : 'Item #' ~ item.id }}</strong>
                        <br><code>{{ item.shortCode }}</code>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>{{ "No items yet."|t('cottage-passport') }} <a href="{{ url('cottage-passport/items/new') }}">{{ "Create one"|t('cottage-passport') }}</a>.</p>
    {% endif %}
{% endblock %}

{% css %}
.passport-qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
}
.qr-card {
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    padding: 12px;
    text-align: center;
    background: #fff;
}
.qr-image img {
    max-width: 100%;
    height: auto;
}
.qr-label {
    margin-top: 8px;
    font-size: 13px;
}
@media print {
    .qr-card { break-inside: avoid; page-break-inside: avoid; }
    #global-container, #crumbs, .buttons, #qr-site-picker, .field { display: none !important; }
    .passport-qr-grid { grid-template-columns: repeat(3, 1fr); }
}
{% endcss %}

{% js %}
(function() {
    var picker = document.getElementById('qr-site-picker');
    var cards = document.querySelectorAll('.qr-card');

    function updateQrCodes() {
        var baseUrl = picker.value.replace(/\/$/, '');
        cards.forEach(function(card) {
            var code = card.dataset.shortcode;
            var scanUrl = baseUrl + '?q=' + encodeURIComponent(code);
            var qrApiUrl = 'https://quickchart.io/qr?size=200&text=' + encodeURIComponent(scanUrl);
            card.querySelector('img').src = qrApiUrl;
        });
    }

    picker.addEventListener('change', updateQrCodes);
    updateQrCodes();

    document.getElementById('btn-print').addEventListener('click', function() {
        window.print();
    });
})();
{% endjs %}
